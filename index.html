<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haunted Map - Paranormal Locations</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c1810, #4a2c17);
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 20px rgba(255, 107, 53, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-logo {
            max-height: 80px;
            max-width: 200px;
            height: auto;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.7));
        }

        .header-text {
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            color: #ff6b35;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            margin-bottom: 10px;
        }

        .header p {
            color: #cccccc;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-logo {
                max-height: 60px;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .map-controls {
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            color: #ff6b35;
            font-size: 0.9em;
            font-weight: bold;
        }

        select, input {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 14px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #ff6b35, #e55a2e);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .map-container {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            border: 2px solid #444;
            position: relative;
            z-index: 1;
        }

        /* Dark theme for the map */
        .leaflet-tile {
            filter: brightness(0.3) contrast(1.5) saturate(0.8) hue-rotate(180deg);
        }

        /* Custom marker styles */
        .haunted-marker {
            background: radial-gradient(circle, #ff6b35, #cc4a1a);
            border: 2px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.7);
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }

        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid #ff6b35 !important;
            border-radius: 10px !important;
            color: #fff !important;
        }

        .leaflet-popup-content {
            color: #fff !important;
            margin: 15px !important;
        }

        .leaflet-popup-content h3 {
            color: #ff6b35 !important;
            margin-bottom: 8px !important;
            font-size: 1.1em !important;
        }

        .leaflet-popup-content p {
            color: #ccc !important;
            font-size: 0.9em !important;
            line-height: 1.4 !important;
        }

        .leaflet-popup-tip {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid #ff6b35 !important;
        }

        .leaflet-popup-close-button {
            color: #ff6b35 !important;
            font-size: 18px !important;
            font-weight: bold !important;
        }

        .locations-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .location-card {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border: 1px solid #444;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .location-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b35, #ff8c42, #ff6b35);
        }

        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.2);
            border-color: #ff6b35;
        }

        /* Location Image Styling */
        .location-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .location-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .location-card:hover .location-image img {
            transform: scale(1.05);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .location-image {
                height: 150px;
            }
        }

        .location-title {
            color: #ff6b35;
            font-size: 1.3em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .location-type {
            display: inline-block;
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 15px;
            border: 1px solid #ff6b35;
        }

        .location-story {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .location-features {
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .location-features h4 {
            color: #ff6b35;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .feature-tag {
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .loading {
            text-align: center;
            color: #ff6b35;
            font-size: 1.2em;
            padding: 40px;
        }

        .instructions {
            background: rgba(42, 42, 42, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ff6b35;
        }

        .instructions h3 {
            color: #ff6b35;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #ccc;
            line-height: 1.5;
        }

        .coordinates {
            color: #aaa;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .activity-high { border-left: 5px solid #ff4444; }
        .activity-moderate { border-left: 5px solid #ffaa44; }
        .activity-low { border-left: 5px solid #44ff44; }

        .statistics {
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            color: #ff6b35;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
        }

        .image-management {
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #ff6b35;
        }

        .fetch-images-btn {
            background: linear-gradient(135deg, #ff6b35, #e55a2e);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
        }

        .fetch-images-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .fetch-images-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .map-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .generate-btn {
                margin-left: 0;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .locations-list {
                grid-template-columns: 1fr;
            }

            .statistics {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <img src="fulllogo.jpg" alt="Logo" class="header-logo">
            <div class="header-text">
                <h1>Interactive Haunted Map</h1>
                <p>Explore Haunted Places and Attractions with Stories.</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="instructions">
            <h3>üó∫Ô∏è How to Use the Map</h3>
            <p>Select your preferences below and click "Apply Filters" to populate the haunted sites. Click on any ghost marker to view the location details. Currently featuring <strong>35 documented haunted locations</strong> in Alabama!</p>
        </div>

        <div class="statistics">
            <div class="stat-item">
                <div class="stat-number" id="totalLocations">35</div>
                <div>Total Locations</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="highActivity">12</div>
                <div>High Activity</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="displayedCount">0</div>
                <div>Currently Displayed</div>
            </div>
        </div>

        <div class="image-management">
            <h3 style="color: #ff6b35; margin-bottom: 15px;">üñºÔ∏è Image Management</h3>
            <button id="fetchImagesBtn" class="fetch-images-btn" onclick="updateHauntedSitesWithImages()">
                üîÆ Fetch Real Images for All Locations
            </button>
            <p style="color: #ccc; font-size: 0.9em; margin-top: 10px;">
                This will replace placeholder images with real photos from Unsplash
            </p>
            <div id="imageProgress" style="margin-top: 15px; color: #ff6b35; display: none;"></div>
        </div>

        <div class="map-controls">
            <div class="control-group">
                <label>State:</label>
                <select id="stateFilter">
                    <option value="">All States</option>
                    <option value="AL" selected>Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NB">Nebraska</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="PR">Puerto Rico</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                </select>
            </div>

            <div class="control-group">
                <label>Location Type:</label>
                <select id="locationType">
                    <option value="">All Types</option>
                    <option value="Cemetery">Cemeteries</option>
                    <option value="Church">Churches</option>
                    <option value="College">Colleges</option>
                    <option value="Ghost Town">Ghost Towns</option>
                    <option value="Historic House">Historic Houses</option>
                    <option value="Hotel">Hotels</option>
                    <option value="Industrial Site">Industrial Sites</option>
                    <option value="Military Site">Military Sites</option>
                    <option value="Mining">Mining Sites</option>
                    <option value="Prison">Prisons</option>
                    <option value="Restaurant">Restaurants</option>
                    <option value="Saloon">Saloons</option>
                    <option value="Terrain">Terrain</option>                    
                    <option value="Theater">Theaters</option>
                </select>
            </div>

            <div class="control-group">
                <label>Activity Level:</label>
                <select id="activityLevel">
                    <option value="">All Levels</option>
                    <option value="low">Low Activity</option>
                    <option value="moderate">Moderate Activity</option>
                    <option value="high">High Activity</option>
                </select>
            </div>

            <div class="control-group">
                <label>Sort By:</label>
                <select id="sortOrder">
                    <option value="alphabetical">Alphabetical (A-Z)</option>
                    <option value="alphabetical-desc">Alphabetical (Z-A)</option>
                    <option value="activity">Activity Level</option>
                    <option value="year">Year Established</option>
                    <option value="type">Location Type</option>
                    <option value="city">City Name</option>
                </select>
            </div>

            <button class="generate-btn" onclick="filterAndDisplayLocations()">
                Apply Filters
            </button>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div id="locationsList" class="locations-list">
            <!-- Generated locations will appear here -->
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // === IMAGE FETCHER CODE ===
        class HauntedImageFetcher {
            constructor(unsplashApiKey) {
                this.apiKey = unsplashApiKey;
                this.cache = new Map();
                this.rateLimitDelay = 1100;
                
                this.fallbackImages = {
                    "Cemetery": "https://source.unsplash.com/800x600/?cemetery,gothic,historic",
                    "Church": "https://source.unsplash.com/800x600/?church,historic,architecture",
                    "College": "https://source.unsplash.com/800x600/?university,campus,historic",
                    "Ghost Town": "https://source.unsplash.com/800x600/?abandoned,town,desert",
                    "Historic House": "https://source.unsplash.com/800x600/?mansion,victorian,historic",
                    "Hotel": "https://source.unsplash.com/800x600/?hotel,historic,vintage",
                    "Industrial Site": "https://source.unsplash.com/800x600/?industrial,abandoned,factory",
                    "Military Site": "https://source.unsplash.com/800x600/?fort,military,historic",
                    "Mining Site": "https://source.unsplash.com/800x600/?mine,abandoned,industrial",
                    "Prison": "https://source.unsplash.com/800x600/?prison,bars,abandoned",
                    "Restaurant": "https://source.unsplash.com/800x600/?restaurant,historic,vintage",
                    "Saloon": "https://source.unsplash.com/800x600/?saloon,western,vintage",
                    "Terrain": "https://source.unsplash.com/800x600/?landscape,spooky,dark",
                    "Theater": "https://source.unsplash.com/800x600/?theater,vintage,architecture"
                };
            }

            createSearchQuery(site) {
                const { name, city, state, type } = site;
                const cleanName = name.replace(/^The\s+/i, '').replace(/\s+(House|Hotel|Theater|Prison)$/i, '');
                
                return [
                    `${name} ${city} ${state}`,
                    `${cleanName} ${city} historic`,
                    `${name} haunted`,
                    `${type.toLowerCase()} ${city} ${state}`,
                    `historic ${type.toLowerCase()}`
                ];
            }

            async fetchFromUnsplash(query) {
                if (this.cache.has(query)) {
                    return this.cache.get(query);
                }

                try {
                    const response = await fetch(
                        `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=3&orientation=landscape`,
                        {
                            headers: {
                                'Authorization': `Client-ID ${this.apiKey}`
                            }
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        const bestImage = data.results.find(img => 
                            img.description && (
                                img.description.toLowerCase().includes('historic') ||
                                img.description.toLowerCase().includes('architecture') ||
                                img.description.toLowerCase().includes('building')
                            )
                        ) || data.results[0];
                        
                        const imageUrl = bestImage.urls.regular;
                        this.cache.set(query, imageUrl);
                        return imageUrl;
                    }
                } catch (error) {
                    console.warn(`Failed to fetch image for query "${query}":`, error.message);
                }
                
                return null;
            }

            async getImageForSite(site) {
                const queries = this.createSearchQuery(site);
                
                for (const query of queries) {
                    console.log(`Trying query: "${query}" for ${site.name}`);
                    
                    const imageUrl = await this.fetchFromUnsplash(query);
                    if (imageUrl) {
                        console.log(`‚úì Found image for ${site.name}: ${imageUrl}`);
                        return imageUrl;
                    }
                    
                    await this.delay(this.rateLimitDelay);
                }
                
                const fallbackUrl = this.fallbackImages[site.type] || this.fallbackImages["Historic House"];
                console.log(`Using fallback image for ${site.name}: ${fallbackUrl}`);
                return fallbackUrl;
            }

            async processAllSites(sites, progressCallback) {
                const updatedSites = [];
                
                console.log(`Processing ${sites.length} sites...`);
                
                for (let i = 0; i < sites.length; i++) {
                    const site = sites[i];
                    
                    try {
                        console.log(`[${i + 1}/${sites.length}] Processing: ${site.name}`);
                        
                        if (progressCallback) {
                            progressCallback(i + 1, sites.length, site.name);
                        }
                        
                        const imageUrl = await this.getImageForSite(site);
                        
                        const updatedSite = {
                            ...site,
                            imageUrl: imageUrl
                        };
                        
                        updatedSites.push(updatedSite);
                        
                    } catch (error) {
                        console.error(`Error processing ${site.name}:`, error);
                        updatedSites.push({
                            ...site,
                            imageUrl: this.fallbackImages[site.type] || this.fallbackImages["Historic House"]
                        });
                    }
                }
                
                return updatedSites;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Function to update your haunted locations with real images
        async function updateHauntedSitesWithImages() {
            const apiKey = 'YOUR_UNSPLASH_API_KEY_HERE'; // Replace with your actual API key
            
            if (apiKey === 'YOUR_UNSPLASH_API_KEY_HERE') {
                alert('Please add your Unsplash API key to the script first!');
                return;
            }
            
            const fetcher = new HauntedImageFetcher(apiKey);
            const progressDiv = document.getElementById('imageProgress');
            const button = document.getElementById('fetchImagesBtn');
            
            try {
                button.disabled = true;
                button.textContent = 'üîÑ Fetching Images...';
                progressDiv.style.display = 'block';
                progressDiv.textContent = 'Starting image fetch process...';
                
                console.log('Starting image fetch process...');
                
                const updatedSites = await fetcher.processAllSites(hauntedLocations, (current, total, siteName) => {
                    progressDiv.textContent = `Processing ${current}/${total}: ${siteName}`;
                });
                
                // Replace the original array with updated images
                hauntedLocations.length = 0;
                hauntedLocations.push(...updatedSites);
                
                console.log('‚úì Image fetch complete! Refreshing display...');
                progressDiv.textContent = '‚úì Image fetch complete! Refreshing display...';
                
                // Refresh the display with new images
                filterAndDisplayLocations();
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    button.disabled = false;
                    button.textContent = '‚úì Images Updated Successfully!';
                    
                    setTimeout(() => {
                        button.textContent = 'üîÆ Fetch Real Images for All Locations';
                    }, 3000);
                }, 2000);
                
            } catch (error) {
                console.error('Error updating images:', error);
                progressDiv.textContent = '‚ùå Error fetching images. Check console for details.';
                button.disabled = false;
                button.textContent = 'üîÆ Fetch Real Images for All Locations';
            }
        }
        // === END IMAGE FETCHER CODE ===

        // Initialize the map - Center on Alabama initially
        let map = L.map('map').setView([32.806671, -86.79113], 7);

        // Add dark-themed tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Store markers for clearing
        let markersGroup = L.layerGroup().addTo(map);

        // Optimized haunted locations database - Alabama locations
        const hauntedLocations = [
            {
                id: "al001",
                state: "AL",
                name: "Sloss Furnaces",
                city: "Birmingham",
                coordinates: [33.5186, -86.8025],
                story: "Former iron-producing facility where harsh working conditions led to numerous fatal accidents. James 'Slag' Wormwood, a brutal foreman, pushed workers to dangerous limits until 47 died under his watch.",
                features: ["Disembodied Voices", "Physical Pushing", "Apparitions", "Extreme Cold Spots"],
                activityLevel: "high",
                yearEstablished: 1882,
                type: "Industrial Site",
                imageUrl: "https://example.com/images/sloss-furnaces.jpg"
            },
            {
                id: "al002",
                state: "AL",
                name: "The Drish House",
                city: "Tuscaloosa",
                coordinates: [33.2098, -87.5692],
                story: "Antebellum mansion where Dr. John R. Drish died from a drunken fall in 1867. His widow Sarah became obsessed with preserving his funeral candles.",
                features: ["Phantom Fires", "Ghostly Lights", "Apparitions", "Cold Spots"],
                activityLevel: "high",
                yearEstablished: 1837,
                type: "Historic House",
                imageUrl: "https://example.com/images/the-drish-house.jpg"
            },
            {
                id: "al003",
                state: "AL",
                name: "Dead Children's Playground",
                city: "Huntsville",
                coordinates: [34.7304, -86.5861],
                story: "Playground within Maple Hill Cemetery where children who died during the 1918 Spanish flu epidemic are buried.",
                features: ["Self-Moving Swings", "Children's Laughter", "Orbs in Photos", "Disembodied Voices"],
                activityLevel: "high",
                yearEstablished: 1822,
                type: "Cemetery",
                imageUrl: "https://example.com/images/dead-children-playground.jpg"
            }
        ];

        let currentDisplayedLocations = [];

        // Activity level colors for map markers
        const activityColors = {
            high: '#ff4444',
            moderate: '#ffaa44',
            low: '#44ff44'
        };

        // Initialize the application
        function initializeApp() {
            updateStatistics();
            displayAllLocations();
        }

        // Filter and display locations based on current selections
        function filterAndDisplayLocations() {
            const stateFilter = document.getElementById('stateFilter').value;
            const typeFilter = document.getElementById('locationType').value;
            const activityFilter = document.getElementById('activityLevel').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // Filter locations
            let filteredLocations = hauntedLocations.filter(location => {
                const stateMatch = !stateFilter || location.state === stateFilter;
                const typeMatch = !typeFilter || location.type === typeFilter;
                const activityMatch = !activityFilter || location.activityLevel === activityFilter;
                return stateMatch && typeMatch && activityMatch;
            });

            // Sort locations based on selected option
            filteredLocations = sortLocations(filteredLocations, sortOrder);

            currentDisplayedLocations = filteredLocations;
            
            // Show loading
            document.getElementById('locationsList').innerHTML = '<div class="loading">üîÆ Filtering haunted locations...</div>';
            
            setTimeout(() => {
                displayLocationsOnMap(filteredLocations);
                displayLocationsList(filteredLocations);
                updateDisplayedCount(filteredLocations.length);
                
                // Center map on filtered results
                if (filteredLocations.length > 0) {
                    centerMapOnLocations(filteredLocations);
                }
            }, 1000);
        }

        // Sort locations based on selected criteria
        function sortLocations(locations, sortBy) {
            const sortedLocations = [...locations];
            
            switch(sortBy) {
                case 'alphabetical':
                    return sortedLocations.sort((a, b) => a.name.localeCompare(b.name));
                case 'alphabetical-desc':
                    return sortedLocations.sort((a, b) => b.name.localeCompare(a.name));
                case 'activity':
                    const activityOrder = { 'high': 3, 'moderate': 2, 'low': 1 };
                    return sortedLocations.sort((a, b) => {
                        const aOrder = activityOrder[a.activityLevel];
                        const bOrder = activityOrder[b.activityLevel];
                        return bOrder - aOrder;
                    });
                case 'year':
                    return sortedLocations.sort((a, b) => a.yearEstablished - b.yearEstablished);
                case 'type':
                    return sortedLocations.sort((a, b) => a.type.localeCompare(b.type));
                case 'city':
                    return sortedLocations.sort((a, b) => a.city.localeCompare(b.city));
                default:
                    return sortedLocations.sort((a, b) => a.name.localeCompare(b.name));
            }
        }

        // Display all locations initially
        function displayAllLocations() {
            const sortOrder = document.getElementById('sortOrder')?.value || 'alphabetical';
            const sortedLocations = sortLocations(hauntedLocations, sortOrder);
            currentDisplayedLocations = sortedLocations;
            displayLocationsOnMap(sortedLocations);
            displayLocationsList(sortedLocations);
            updateDisplayedCount(sortedLocations.length);
        }

        // Center map on a set of locations
        function centerMapOnLocations(locations) {
            if (locations.length === 0) return;
            
            if (locations.length === 1) {
                map.setView(locations[0].coordinates, 10);
            } else {
                const group = new L.featureGroup(locations.map(loc => 
                    L.marker(loc.coordinates)
                ));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Display locations on map
        function displayLocationsOnMap(locations) {
            markersGroup.clearLayers();

            locations.forEach(location => {
                const hauntedIcon = L.divIcon({
                    className: 'haunted-marker',
                    html: 'üëª',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker(location.coordinates, {
                    icon: hauntedIcon
                }).addTo(markersGroup);

                const popupContent = `
                    <h3>${location.name}</h3>
                    ${location.imageUrl ? `
                        <img src="${location.imageUrl}" 
                             alt="${location.name}" 
                             style="width: 100%; max-width: 200px; height: auto; border-radius: 5px; margin: 10px 0;"
                             onerror="this.style.display='none'">
                    ` : ''}
                    <p><strong>Location:</strong> ${location.city}, ${location.state}</p>
                    <p><strong>Type:</strong> ${location.type}</p>
                    <p><strong>Activity Level:</strong> ${location.activityLevel}</p>
                    <p><strong>Story:</strong> ${location.story.substring(0, 150)}...</p>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'haunted-popup'
                });

                marker.on('click', () => {
                    const locationCard = document.querySelector(`[data-id="${location.id}"]`);
                    if (locationCard) {
                        locationCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        locationCard.style.transform = 'scale(1.02)';
                        setTimeout(() => {
                            locationCard.style.transform = 'scale(1)';
                        }, 1000);
                    }
                });
            });
        }

        // Display locations list
        function displayLocationsList(locations) {
            const listContainer = document.getElementById('locationsList');
            
            listContainer.innerHTML = locations.map(location => `
                <div class="location-card activity-${location.activityLevel}" data-id="${location.id}">
                    ${location.imageUrl ? `
                        <div class="location-image">
                            <img src="${location.imageUrl}" 
                                 alt="${location.name}" 
                                 onerror="this.style.display='none'"
                                 loading="lazy">
                        </div>
                    ` : ''}
                    <div class="location-title">${location.name}</div>
                    <div class="coordinates">üìç ${location.city}, ${location.state}</div>
                    <div class="location-type">${location.type}</div>
                    <div class="location-story">${location.story}</div>
                    <div class="location-features">
                        <h4>Reported Phenomena:</h4>
                        <div class="features-list">
                            ${location.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStatistics() {
            const totalCount = hauntedLocations.length;
            const highActivityCount = hauntedLocations.filter(loc => loc.activityLevel === 'high').length;
            
            document.getElementById('totalLocations').textContent = totalCount;
            document.getElementById('highActivity').textContent = highActivityCount;
        }

        // Update displayed count
        function updateDisplayedCount(count) {
            document.getElementById('displayedCount').textContent = count;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // Add event listeners for filtering
        document.getElementById('stateFilter').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('locationType').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('activityLevel').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('sortOrder').addEventListener('change', filterAndDisplayLocations);
    </script>
</body>
</html>
