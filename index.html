<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haunt Map - Paranormal Locations</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
 
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
 
        .header {
            background: linear-gradient(135deg, #2c1810, #4a2c17);
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 20px rgba(255, 107, 53, 0.3);
        }
 
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            text-align: center;
        }
 
        .header-logo {
            max-height: 80px;
            max-width: 200px;
            height: auto;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.7));
            flex-shrink: 0;
        }
 
        .header-text {
            text-align: center;
        }
 
        .header h1 {
            font-size: 2.5em;
            color: #ff6b35;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            margin-bottom: 10px;
        }
 
        .header p {
            color: #cccccc;
            font-size: 1.1em;
        }
 
        @media (max-width: 768px) {
            .header-content {
                 gap: 15px;
             }
            
             .header-logo {
                max-height: 60px;
            }
        }
 
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
 
        .map-controls {
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
 
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
 
        .control-group label {
            color: #ff6b35;
            font-size: 0.9em;
            font-weight: bold;
        }
 
        select, input {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 14px;
        }
 
        .generate-btn {
            background: linear-gradient(135deg, #ff6b35, #e55a2e);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: auto;
        }
 
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
 
        .map-container {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
 
        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            border: 2px solid #444;
            position: relative;
            z-index: 1;
        }
 
        /* Custom marker styles */
        .haunted-marker {
            background: radial-gradient(circle, #ff6b35, #cc4a1a);
            border: 2px solid #ff8c42;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.7);
            animation: pulse 2s infinite;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .haunted-marker:hover,
        .haunted-marker.selected {
            opacity: 0.7;
        }
 
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }
 
        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid #ff6b35 !important;
            border-radius: 10px !important;
            color: #fff !important;
        }
 
        .leaflet-popup-content {
            color: #fff !important;
            margin: 15px !important;
        }
 
        .leaflet-popup-content h3 {
            color: #ff6b35 !important;
            margin-bottom: 8px !important;
            font-size: 1.1em !important;
        }
 
        .leaflet-popup-content p {
            color: #ccc !important;
            font-size: 0.9em !important;
            line-height: 1.4 !important;
        }
 
        .leaflet-popup-tip {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid #ff6b35 !important;
        }
 
        .leaflet-popup-close-button {
            color: #ff6b35 !important;
            font-size: 18px !important;
            font-weight: bold !important;
        }
 
        .locations-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
 
        .location-card {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border: 1px solid #444;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
 
        .location-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b35, #ff8c42, #ff6b35);
        }
 
        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.2);
            border-color: #ff6b35;
        }
 
        /* Location Image Styling */
        .location-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 15px;
        }
 
        .location-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
 
        .location-card:hover .location-image img {
            transform: scale(1.05);
        }
 
        /* Mobile responsive */
        @media (max-width: 768px) {
            .location-image {
                height: 150px;
            }
        }
 
        .location-title {
            color: #ff6b35;
            font-size: 1.3em;
            margin-bottom: 10px;
            font-weight: bold;
        }
 
        .location-type {
            display: inline-block;
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 15px;
            border: 1px solid #ff6b35;
        }
 
        .location-story {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 15px;
        }
 
        .location-features {
            border-top: 1px solid #333;
            padding-top: 15px;
        }
 
        .location-features h4 {
            color: #ff6b35;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
 
        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
 
        .feature-tag {
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }
 
        .loading {
            text-align: center;
            color: #ff6b35;
            font-size: 1.2em;
            padding: 40px;
        }
 
        .coordinates {
            color: #aaa;
            font-size: 0.8em;
            margin-bottom: 10px;
        }
 
        .activity-high { border-left: 5px solid #ff4444; }
        .activity-moderate { border-left: 5px solid #ffaa44; }
        .activity-low { border-left: 5px solid #44ff44; }
 
        .statistics {
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
 
        .stat-item {
            color: #ff6b35;
        }
 
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
        }
 
        .image-management {
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #ff6b35;
        }
 
        .fetch-images-btn {
            background: linear-gradient(135deg, #ff6b35, #e55a2e);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
        }
 
        .fetch-images-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }
 
        .fetch-images-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .image-source-badge {
            display: inline-block;
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            margin-top: 5px;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .legend {
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .legend-items {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ccc;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .activity-high-legend {
            background: #ff4444;
        }

        .activity-moderate-legend {
            background: #ffaa44;
        }

        .activity-low-legend {
            background: #44ff44;
        }
 
        @media (max-width: 768px) {
            .map-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .generate-btn {
                margin-left: 0;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .locations-list {
                grid-template-columns: 1fr;
            }
 
            .statistics {
                flex-direction: column;
                gap: 10px;
            }

            .legend-items {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .legend-item {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <img src="fulllogo_nobuffer.jpg" alt="Logo" class="header-logo">
            <div class="header-text">
                <h1>Haunt Map</h1>
                <p>Explore Haunted Places and Attractions with Stories.</p>
            </div>
        </div>
    </div>
 
    <div class="container">
        <div class="statistics">
            <div class="stat-item">
                <div class="stat-number" id="totalLocations">20</div>
                <div>Total Locations</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="highActivity">4</div>
                <div>High Activity</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="displayedCount">0</div>
                <div>Currently Displayed</div>
            </div>
        </div>

        <div class="legend">
            <h3 style="color: #ff6b35; margin-bottom: 15px; text-align: center;">Activity Level Legend</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color activity-low-legend"></div>
                    <span>Low Activity - Occasional spiritual presence</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color activity-moderate-legend"></div>
                    <span>Moderate Activity - Regular unexplained phenomena</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color activity-high-legend"></div>
                    <span>High Activity - Frequent paranormal encounters</span>
                </div>
            </div>
        </div>
 
        <div class="image-management">
            <h3 style="color: #ff6b35; margin-bottom: 15px;">Photo Gallery</h3>
            <button id="fetchImagesBtn" class="fetch-images-btn" onclick="updateHauntedSitesWithImages()">
                View Location Images
            </button>
            <p style="color: #ccc; font-size: 0.9em; margin-top: 10px;">
                
            </p>
            <div id="imageProgress" style="margin-top: 15px; color: #ff6b35; display: none;"></div>
        </div>
 
        <div class="map-controls">
            <div class="control-group">
                <label>State:</label>
                <select id="stateFilter">
                    <option value="" selected>All States</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="DC">District of Columbia</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NB">Nebraska</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="PR">Puerto Rico</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                </select>
            </div>
 
            <div class="control-group">
                <label>Location Type:</label>
                <select id="locationType">
                    <option value="">All Types</option>
                    <option value="Cemetery">Cemeteries</option>
                    <option value="Church">Churches</option>
                    <option value="College">Colleges</option>
                    <option value="Ghost Town">Ghost Towns</option>
                    <option value="Historic House">Historic Houses</option>
                    <option value="Hotel">Hotels</option>
                    <option value="Industrial Site">Industrial Sites</option>
                    <option value="Military Site">Military Sites</option>
                    <option value="Mining">Mining Sites</option>
                    <option value="Prison">Prisons</option>
                    <option value="Restaurant">Restaurants</option>
                    <option value="Saloon">Saloons</option>
                    <option value="Terrain">Terrain</option>                    
                    <option value="Theater">Theaters</option>
                </select>
            </div>
 
            <div class="control-group">
                <label>Activity Level:</label>
                <select id="activityLevel">
                    <option value="">All Levels</option>
                    <option value="low">Low Activity</option>
                    <option value="moderate">Moderate Activity</option>
                    <option value="high">High Activity</option>
                </select>
            </div>
 
            <div class="control-group">
                <label>Sort By:</label>
                <select id="sortOrder">
                    <option value="alphabetical">Alphabetical (A-Z)</option>
                    <option value="alphabetical-desc">Alphabetical (Z-A)</option>
                    <option value="activity">Activity Level</option>
                    <option value="year">Year Established</option>
                    <option value="type">Location Type</option>
                    <option value="city">City Name</option>
                </select>
            </div>
 
            <button class="generate-btn" onclick="filterAndDisplayLocations()">
                Apply Filters
            </button>
        </div>
 
        <div class="map-container">
            <div id="map"></div>
        </div>
 
        <div id="locationsList" class="locations-list">
            <!-- Generated locations will appear here -->
        </div>
    </div>
 
    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // === MULTI-SOURCE IMAGE FETCHER CODE ===
        class HauntedLocationImageFetcher {
            constructor() {
                this.cache = new Map();
                this.rateLimitDelay = 1200;
                
                // Public domain and free image sources
                this.imageSources = {
                    wikimedia: 'https://commons.wikimedia.org/w/api.php',
                    unsplash: 'https://api.unsplash.com/search/photos'
                };
                
                this.fallbackImages = {
                    "Cemetery": "https://images.unsplash.com/photo-1520500807606-fd6f5db4b18b?w=800&h=600&fit=crop",
                    "Church": "https://images.unsplash.com/photo-1569425409825-4b01c4b1d6c4?w=800&h=600&fit=crop", 
                    "College": "https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=800&h=600&fit=crop",
                    "Ghost Town": "https://images.unsplash.com/photo-1441260038675-7329ab4cc264?w=800&h=600&fit=crop",
                    "Historic House": "https://images.unsplash.com/photo-1520637836862-4d197d17c73a?w=800&h=600&fit=crop",
                    "Hotel": "https://images.unsplash.com/photo-1580587771525-78b9dba3b914?w=800&h=600&fit=crop",
                    "Industrial Site": "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=800&h=600&fit=crop",
                    "Military Site": "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&h=600&fit=crop",
                    "Mining Site": "https://images.unsplash.com/photo-1446776877081-d282a0f896e2?w=800&h=600&fit=crop",
                    "Prison": "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=800&h=600&fit=crop",
                    "Restaurant": "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800&h=600&fit=crop",
                    "Saloon": "https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=800&h=600&fit=crop",
                    "Terrain": "https://images.unsplash.com/photo-1439066615861-d1af74d74000?w=800&h=600&fit=crop",
                    "Theater": "https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=800&h=600&fit=crop"
                };
            }
 
            createSearchQueries(site) {
                const { name, city, state, type, country = 'US' } = site;
                const cleanName = name.replace(/^The\s+/i, '').replace(/\s+(House|Hotel|Theater|Prison|Cemetery|Mansion)$/i, '');
                
                // Prioritize exact location matches first, then broader searches
                const queries = [
                    `"${name}" ${city} ${state}`,
                    `"${cleanName}" ${city}`,
                    `${name} ${state}`,
                    `${cleanName} ${city} ${country === 'UK' ? 'England' : state}`,
                    `${name.split(' ')[0]} ${type.toLowerCase()} ${city}`,
                    `historic ${type.toLowerCase()} ${city} ${state}`,
                ];
                
                // Add UK-specific searches
                if (country === 'UK') {
                    queries.push(
                        `${cleanName} England`,
                        `${cleanName} Britain UK`,
                        `${name} castle England`
                    );
                }
                
                return queries.filter(Boolean);
            }
 
            async searchWikimediaCommons(query) {
                try {
                    const searchUrl = `${this.imageSources.wikimedia}?action=query&format=json&list=search&srsearch=${encodeURIComponent(query + ' file:')}&srnamespace=6&srlimit=10&origin=*`;
                    
                    const response = await fetch(searchUrl);
                    const data = await response.json();
                    
                    if (data.query && data.query.search && data.query.search.length > 0) {
                        // Get the first result and fetch its image URL
                        const firstResult = data.query.search[0];
                        const imageInfoUrl = `${this.imageSources.wikimedia}?action=query&format=json&prop=imageinfo&iiprop=url|size&titles=${encodeURIComponent(firstResult.title)}&origin=*`;
                        
                        const imageResponse = await fetch(imageInfoUrl);
                        const imageData = await imageResponse.json();
                        
                        const pages = imageData.query?.pages;
                        if (pages) {
                            const page = Object.values(pages)[0];
                            if (page.imageinfo && page.imageinfo[0]) {
                                return {
                                    url: page.imageinfo[0].url,
                                    source: 'wikimedia',
                                    license: 'public domain'
                                };
                            }
                        }
                    }
                } catch (error) {
                    console.warn(`Wikimedia search failed for "${query}":`, error.message);
                }
                return null;
            }
 
            async searchUnsplash(query, apiKey) {
                if (!apiKey || apiKey === 'YOUR_API_KEY_HERE') return null;
                
                try {
                    const response = await fetch(
                        `${this.imageSources.unsplash}?query=${encodeURIComponent(query)}&per_page=5&orientation=landscape`,
                        {
                            headers: {
                                'Authorization': `Client-ID ${apiKey}`
                            }
                        }
                    );
 
                    if (!response.ok) return null;
 
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        // Prioritize images with location names in description
                        const bestMatch = data.results.find(img => {
                            const desc = (img.description || '').toLowerCase();
                            const alt = (img.alt_description || '').toLowerCase();
                            return desc.includes(query.toLowerCase().split(' ')[0]) || 
                                   alt.includes(query.toLowerCase().split(' ')[0]);
                        }) || data.results[0];
                        
                        return {
                            url: bestMatch.urls.regular,
                            source: 'unsplash',
                            license: 'unsplash license'
                        };
                    }
                } catch (error) {
                    console.warn(`Unsplash search failed for "${query}":`, error.message);
                }
                return null;
            }
 
            async getImageForLocation(site, apiKeys = {}) {
                const cacheKey = `${site.name}-${site.city}-${site.state}`;
                
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }
 
                const queries = this.createSearchQueries(site);
                
                for (const query of queries) {
                    console.log(`Searching for: "${query}" (${site.name})`);
                    
                    // Try Wikimedia Commons first (public domain)
                    let result = await this.searchWikimediaCommons(query);
                    if (result) {
                        console.log(`✓ Found Wikimedia image for ${site.name}`);
                        this.cache.set(cacheKey, result);
                        return result;
                    }
                    
                    await this.delay(800);
                    
                    // Try Unsplash as secondary source
                    result = await this.searchUnsplash(query, apiKeys.unsplash);
                    if (result) {
                        console.log(`✓ Found Unsplash image for ${site.name}`);
                        this.cache.set(cacheKey, result);
                        return result;
                    }
                    
                    await this.delay(this.rateLimitDelay);
                }
                
                // Use fallback if no results found
                const fallbackUrl = this.fallbackImages[site.type] || this.fallbackImages["Historic House"];
                const fallbackResult = {
                    url: fallbackUrl,
                    source: 'fallback',
                    license: 'unsplash'
                };
                
                console.log(`Using fallback for ${site.name}`);
                this.cache.set(cacheKey, fallbackResult);
                return fallbackResult;
            }
 
            async processAllLocations(sites, progressCallback, apiKeys = {}) {
                const updatedSites = [];
                console.log(`Processing ${sites.length} haunted locations...`);
                
                for (let i = 0; i < sites.length; i++) {
                    const site = sites[i];
                    
                    try {
                        if (progressCallback) {
                            progressCallback(i + 1, sites.length, site.name);
                        }
                        
                        const imageResult = await this.getImageForLocation(site, apiKeys);
                        
                        updatedSites.push({
                            ...site,
                            imageUrl: imageResult.url,
                            imageSource: imageResult.source,
                            imageLicense: imageResult.license
                        });
                        
                    } catch (error) {
                        console.error(`Error processing ${site.name}:`, error);
                        
                        updatedSites.push({
                            ...site,
                            imageUrl: this.fallbackImages[site.type] || this.fallbackImages["Historic House"],
                            imageSource: 'fallback',
                            imageLicense: 'unsplash'
                        });
                    }
                }
                
                return updatedSites;
            }
 
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Function to update haunted locations with authentic images
        async function updateHauntedSitesWithImages() {
            const apiKeys = {
                unsplash: '3t7QkwquuCZ6faMM80mIMkrAQlybHcukcnrRADjhy_M'
            };
            
            const fetcher = new HauntedLocationImageFetcher();
            const progressDiv = document.getElementById('imageProgress');
            const button = document.getElementById('fetchImagesBtn');
            
            try {
                button.disabled = true;
                button.textContent = '🔄 Fetching Authentic Location Images...';
                progressDiv.style.display = 'block';
                progressDiv.textContent = 'Searching for photos of haunted locations...';
                
                console.log('Starting image search process...');
                
                const updatedSites = await fetcher.processAllLocations(hauntedLocations, (current, total, siteName) => {
                    progressDiv.textContent = `Processing ${current}/${total}: ${siteName}`;
                }, apiKeys);
                
                // Replace the original array with updated images
                hauntedLocations.length = 0;
                hauntedLocations.push(...updatedSites);
                
                console.log('✓ Authentic image search complete! Refreshing display...');
                progressDiv.textContent = '✓ Authentic images loaded! Refreshing display...';
                
                // Refresh the display with new images
                filterAndDisplayLocations();
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    button.disabled = false;
                    button.textContent = '✓ Authentic Images Updated Successfully!';
                    
                    setTimeout(() => {
                        button.textContent = 'View Location Images';
                    }, 3000);
                }, 2000);
                
            } catch (error) {
                console.error('Error updating images:', error);
                progressDiv.textContent = '❌ Error fetching images. Check console for details.';
                button.disabled = false;
                button.textContent = 'View Location Images';
            }
        }
        // === END MULTI-SOURCE IMAGE FETCHER CODE ===
 
        // Initialize the map - Center on US initially
        let map = L.map('map').setView([39.8283, -98.5795], 4);

        // Primary tile layer - CartoDB Dark Matter
        const primaryTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        });

        // Fallback tile layer - OpenStreetMap
        const fallbackTiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        // Secondary fallback - Different CartoDB endpoint
        const secondaryTiles = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        });

        // Try to add primary tiles first
        let currentTileLayer = primaryTiles;
        currentTileLayer.addTo(map);

        // Enhanced error handling for tile loading
        let tileErrorCount = 0;
        map.on('tileerror', function(error) {
            console.log('Tile loading error:', error);
            tileErrorCount++;
            
            // If we get multiple tile errors, switch to fallback
            if (tileErrorCount > 3) {
                console.log('Switching to fallback tiles...');
                map.removeLayer(currentTileLayer);
                
                // Try secondary tiles first, then fallback to OSM
                if (currentTileLayer === primaryTiles) {
                    currentTileLayer = secondaryTiles;
                    currentTileLayer.addTo(map);
                } else if (currentTileLayer === secondaryTiles) {
                    currentTileLayer = fallbackTiles;
                    currentTileLayer.addTo(map);
                }
                
                tileErrorCount = 0; // Reset counter
            }
        });

        // Force refresh tiles if still gray after 5 seconds
        setTimeout(() => {
            if (tileErrorCount > 0) {
                console.log('Force switching to OpenStreetMap tiles...');
                map.removeLayer(currentTileLayer);
                currentTileLayer = fallbackTiles;
                currentTileLayer.addTo(map);
            }
        }, 5000);
 
        // Store markers for clearing
        let markersGroup = L.layerGroup().addTo(map);
 
        // Haunted locations database
        const hauntedLocations = [
            {
                id: "al001",
                state: "AL",
                name: "Sloss Furnaces",
                city: "Birmingham",
                coordinates: [33.5186, -86.8025],
                story: "Former iron-producing facility where harsh working conditions led to numerous fatal accidents. James 'Slag' Wormwood, a brutal foreman, pushed workers to dangerous limits until 47 died under his watch. Visitors report being pushed by invisible hands, hearing disembodied voices, and experiencing extreme temperature drops in certain areas of the facility.",
                features: ["Disembodied Voices", "Physical Pushing", "Apparitions", "Extreme Cold Spots"],
                activityLevel: "high",
                yearEstablished: 1882,
                type: "Industrial Site"
            },
            {
                id: "al002",
                state: "AL",
                name: "The Drish House",
                city: "Tuscaloosa",
                coordinates: [33.2098, -87.5692],
                story: "Antebellum mansion where Dr. John R. Drish died from a drunken fall in 1867. His widow Sarah became obsessed with preserving his funeral candles, lighting them nightly in the windows. When she died, the candles mysteriously continued to burn, visible from the street even when the house was empty.",
                features: ["Phantom Fires", "Ghostly Lights", "Apparitions", "Cold Spots"],
                activityLevel: "high",
                yearEstablished: 1837,
                type: "Historic House"
            },
            {
                id: "al003",
                state: "AL",
                name: "Dead Children's Playground",
                city: "Huntsville",
                coordinates: [34.7304, -86.5861],
                story: "Playground within Maple Hill Cemetery where children who died during the 1918 Spanish flu epidemic are buried. The swings move on windless nights, and visitors hear the sound of children's laughter echoing through the darkness.",
                features: ["Self-Moving Swings", "Children's Laughter", "Orbs in Photos", "Disembodied Voices"],
                activityLevel: "high",
                yearEstablished: 1822,
                type: "Cemetery"
            },
            {
                id: "al004",
                state: "AL",
                name: "Old Cahawba Archaeological Park",
                city: "Orrville",
                coordinates: [32.3115, -87.1058],
                story: "Alabama's first state capital, abandoned after repeated flooding. Once home to over 3,000 people, now only ruins remain. Visitors report seeing figures in period clothing walking the old streets and hearing the sounds of a bustling town that no longer exists.",
                features: ["Period Apparitions", "Phantom Sounds", "Shadow Figures", "EMF Spikes"],
                activityLevel: "moderate",
                yearEstablished: 1819,
                type: "Ghost Town"
            },
            {
                id: "al005",
                state: "AL",
                name: "Fort Morgan",
                city: "Gulf Shores",
                coordinates: [30.2299, -88.0208],
                story: "Civil War fortress where Confederate soldiers made their last stand. The fort's dark history includes prisoner deaths, battle casualties, and yellow fever outbreaks. Visitors report seeing soldiers in uniform patrolling the ramparts at night.",
                features: ["Soldier Apparitions", "Cannon Fire Sounds", "Cold Spots", "Electronic Malfunctions"],
                activityLevel: "moderate",
                yearEstablished: 1834,
                type: "Military Site"
            },
            {
                id: "al006",
                state: "AL",
                name: "Gaineswood Mansion",
                city: "Demopolis",
                coordinates: [32.5176, -87.8364],
                story: "Greek Revival mansion built by Nathan Bryan Whitfield, who died during construction in 1860. His spirit allegedly remains to oversee the completion of his masterpiece. Staff report doors opening and closing, piano music from empty rooms, and the scent of his favorite tobacco.",
                features: ["Piano Music", "Tobacco Scent", "Moving Doors", "Apparitions"],
                activityLevel: "moderate",
                yearEstablished: 1843,
                type: "Historic House"
            },
            {
                id: "al007",
                state: "AL",
                name: "Pickens County Courthouse",
                city: "Carrollton",
                coordinates: [33.2618, -88.0953],
                story: "The courthouse window displays a mysterious face burned into the glass - allegedly that of Henry Wells, a man accused of arson who was lynched before trial. He proclaimed his innocence and said his face would appear as proof. The face has remained visible for over 100 years.",
                features: ["Mysterious Face in Window", "Cold Spots", "Unexplained Sounds", "Camera Malfunctions"],
                activityLevel: "moderate",
                yearEstablished: 1877,
                type: "Historic House"
            },
            {
                id: "al008",
                state: "AL",
                name: "USS Alabama Battleship",
                city: "Mobile",
                coordinates: [30.6818, -88.0146],
                story: "WWII battleship now serving as a museum. During its service, several sailors died aboard the ship. Visitors and staff report phantom footsteps on metal decks, voices over the intercom system, and figures in naval uniforms walking the corridors.",
                features: ["Phantom Footsteps", "Intercom Voices", "Naval Apparitions", "Equipment Malfunctions"],
                activityLevel: "moderate",
                yearEstablished: 1942,
                type: "Military Site"
            },
            {
                id: "al009",
                state: "AL",
                name: "Riverside Cemetery",
                city: "Ashland",
                coordinates: [33.2732, -85.8358],
                story: "Small town cemetery where numerous Civil War soldiers are buried. Local legends speak of a weeping woman in black who visits graves on moonless nights. Visitors report seeing glowing orbs, hearing sobbing, and feeling an overwhelming sense of sadness.",
                features: ["Weeping Woman", "Glowing Orbs", "Overwhelming Sadness", "Phantom Sobbing"],
                activityLevel: "moderate",
                yearEstablished: 1845,
                type: "Cemetery"
            },
            {
                id: "al010",
                state: "AL",
                name: "Historic Huntsville Depot",
                city: "Huntsville",
                coordinates: [34.7280, -86.5861],
                story: "Built in 1860, this railroad depot served as a prison during the Civil War. Union soldiers held Confederate prisoners here in terrible conditions. Visitors report hearing the sounds of trains that no longer run and seeing figures in period military uniforms.",
                features: ["Phantom Train Sounds", "Military Apparitions", "Cold Spots", "Unexplained Voices"],
                activityLevel: "moderate",
                yearEstablished: 1860,
                type: "Historic House"
            },
            {
                id: "al011",
                state: "AL",
                name: "Bellingrath Gardens Ghost",
                city: "Theodore",
                coordinates: [30.5524, -88.1617],
                story: "Beautiful 65-acre garden where Bessie Bellingrath's spirit is said to still tend her beloved flowers. Gardeners report tools moving on their own, flowers blooming out of season, and a gentle presence guiding their work.",
                features: ["Moving Garden Tools", "Out-of-Season Blooms", "Gentle Presence", "Floral Scents"],
                activityLevel: "low",
                yearEstablished: 1932,
                type: "Historic House"
            },
            {
                id: "al012",
                state: "AL",
                name: "Blount County Memorial Museum",
                city: "Oneonta",
                coordinates: [33.9482, -86.4725],
                story: "Former schoolhouse turned museum where the spirit of a dedicated teacher allegedly remains. Visitors report chalk writing appearing on blackboards, books falling from shelves, and the sound of children reciting lessons in empty classrooms.",
                features: ["Phantom Writing", "Falling Books", "Children's Voices", "Classroom Sounds"],
                activityLevel: "low",
                yearEstablished: 1907,
                type: "Historic House"
            },
            {
                id: "al013",
                state: "AL",
                name: "Noccalula Falls",
                city: "Gadsden",
                coordinates: [34.0212, -86.0219],
                story: "Legend tells of Noccalula, a Cherokee princess who jumped to her death rather than marry against her will. Visitors report seeing a woman in white near the falls, feeling sudden sadness, and hearing mournful singing carried on the wind.",
                features: ["Woman in White", "Sudden Sadness", "Mournful Singing", "Temperature Drops"],
                activityLevel: "low",
                yearEstablished: 1800,
                type: "Terrain"
            },
            {
                id: "al014",
                state: "AL",
                name: "Ave Maria Grotto",
                city: "Cullman",
                coordinates: [34.1848, -86.8436],
                story: "Miniature Jerusalem built by Brother Joseph Zoettl. Some visitors report seeing a monk-like figure tending to the tiny buildings and experiencing an overwhelming sense of peace and spiritual presence among the grottos.",
                features: ["Monk Apparition", "Spiritual Presence", "Peaceful Energy", "Moving Shadows"],
                activityLevel: "low",
                yearEstablished: 1934,
                type: "Church"
            },
            {
                id: "al015",
                state: "AL",
                name: "Shorter Mansion",
                city: "Eufaula",
                coordinates: [31.8915, -85.1455],
                story: "Neoclassical mansion where Eli Shorter II died in 1906. His widow reported seeing him in his favorite chair reading the newspaper each morning. Current staff and visitors continue to report sightings of a distinguished gentleman in the parlor.",
                features: ["Gentleman Apparition", "Moving Newspapers", "Phantom Reading", "Cigar Smoke Scent"],
                activityLevel: "low",
                yearEstablished: 1884,
                type: "Historic House"
            },
            {
                id: "al016",
                state: "AL",
                name: "Oakleigh Mansion",
                city: "Mobile",
                coordinates: [30.6977, -88.0567],
                story: "Greek Revival mansion where the Irwin family lived for generations. Visitors report seeing a woman in a blue dress gliding through the halls, believed to be one of the Irwin daughters who died young. The scent of magnolias often accompanies her presence.",
                features: ["Woman in Blue Dress", "Magnolia Scent", "Gliding Apparition", "Piano Music"],
                activityLevel: "moderate",
                yearEstablished: 1833,
                type: "Historic House"
            },
            {
                id: "al017",
                state: "AL",
                name: "Redstone Arsenal",
                city: "Huntsville",
                coordinates: [34.6834, -86.6503],
                story: "Former WWII chemical weapons manufacturing site and current rocket development facility. Security guards report unexplained lights in abandoned buildings, strange odors that medical tests cannot identify, and equipment that operates on its own.",
                features: ["Unexplained Lights", "Strange Odors", "Equipment Malfunctions", "Security Alerts"],
                activityLevel: "moderate",
                yearEstablished: 1941,
                type: "Military Site"
            },
            {
                id: "al018",
                state: "AL",
                name: "Lotz House Museum",
                city: "Franklin",
                coordinates: [35.9251, -86.8689],
                story: "Civil War era house that served as a Confederate hospital. The Lotz family reported paranormal activity for generations, including soldiers appearing in bedrooms, medical equipment moving, and the sounds of surgery being performed.",
                features: ["Soldier Apparitions", "Medical Sounds", "Moving Equipment", "Phantom Surgery"],
                activityLevel: "high",
                yearEstablished: 1858,
                type: "Historic House"
            },
            {
                id: "al019",
                state: "AL",
                name: "Bottle Tree Ranch",
                city: "Millerville",
                coordinates: [32.8751, -85.7816],
                story: "Art installation of bottle trees based on African American folk tradition. According to legend, the bottles trap evil spirits. Visitors report unusual electromagnetic readings, mysterious lights within the bottles at night, and an eerie silence that falls over the area.",
                features: ["Trapped Spirit Energy", "Bottle Lights", "EMF Anomalies", "Unnatural Silence"],
                activityLevel: "low",
                yearEstablished: 1990,
                type: "Terrain"
            },
            {
                id: "al020",
                state: "AL",
                name: "St. Elmo Historic District",
                city: "Mobile",
                coordinates: [30.6504, -88.1137],
                story: "Historic neighborhood where numerous antebellum homes are said to be haunted. Residents report seeing carriages that cast no shadows, hearing horse hooves on modern pavement, and witnessing figures in period dress walking the streets after midnight.",
                features: ["Phantom Carriages", "Horse Hoof Sounds", "Period Apparitions", "Shadow Figures"],
                activityLevel: "moderate",
                yearEstablished: 1840,
                type: "Historic House"
            }
        ];

        let currentDisplayedLocations = [];
 
        // Initialize the application
        function initializeApp() {
            updateStatistics();
            displayAllLocations();
        }
 
        // Filter and display locations based on current selections
        function filterAndDisplayLocations() {
            const stateFilter = document.getElementById('stateFilter').value;
            const typeFilter = document.getElementById('locationType').value;
            const activityFilter = document.getElementById('activityLevel').value;
            const sortOrder = document.getElementById('sortOrder').value;
 
            // Filter locations
            let filteredLocations = hauntedLocations.filter(location => {
                const stateMatch = !stateFilter || location.state === stateFilter;
                const typeMatch = !typeFilter || location.type === typeFilter;
                const activityMatch = !activityFilter || location.activityLevel === activityFilter;
                return stateMatch && typeMatch && activityMatch;
            });
 
            // Sort locations based on selected option
            filteredLocations = sortLocations(filteredLocations, sortOrder);
 
            currentDisplayedLocations = filteredLocations;
            
            // Show loading
            document.getElementById('locationsList').innerHTML = '<div class="loading">Filtering haunted locations...</div>';
            
            setTimeout(() => {
                displayLocationsOnMap(filteredLocations);
                displayLocationsList(filteredLocations);
                updateDisplayedCount(filteredLocations.length);
                
                // Center map on filtered results
                if (filteredLocations.length > 0) {
                    centerMapOnLocations(filteredLocations);
                }
            }, 1000);
        }
 
        // Sort locations based on selected criteria
        function sortLocations(locations, sortBy) {
            const sortedLocations = [...locations];
            
            switch(sortBy) {
                case 'alphabetical':
                    return sortedLocations.sort((a, b) => a.name.localeCompare(b.name));
                case 'alphabetical-desc':
                    return sortedLocations.sort((a, b) => b.name.localeCompare(a.name));
                case 'activity':
                    const activityOrder = { 'high': 3, 'moderate': 2, 'low': 1 };
                    return sortedLocations.sort((a, b) => {
                        const aOrder = activityOrder[a.activityLevel];
                        const bOrder = activityOrder[b.activityLevel];
                        return bOrder - aOrder;
                    });
                case 'year':
                    return sortedLocations.sort((a, b) => a.yearEstablished - b.yearEstablished);
                case 'type':
                    return sortedLocations.sort((a, b) => a.type.localeCompare(b.type));
                case 'city':
                    return sortedLocations.sort((a, b) => a.city.localeCompare(b.city));
                default:
                    return sortedLocations.sort((a, b) => a.name.localeCompare(b.name));
            }
        }
 
        // Display all locations initially
        function displayAllLocations() {
            const sortOrder = document.getElementById('sortOrder')?.value || 'alphabetical';
            const sortedLocations = sortLocations(hauntedLocations, sortOrder);
            currentDisplayedLocations = sortedLocations;
            displayLocationsOnMap(sortedLocations);
            displayLocationsList(sortedLocations);
            updateDisplayedCount(sortedLocations.length);
        }
 
        // Center map on a set of locations
        function centerMapOnLocations(locations) {
            if (locations.length === 0) return;
            
            if (locations.length === 1) {
                map.setView(locations[0].coordinates, 10);
            } else {
                const group = new L.featureGroup(locations.map(loc => 
                    L.marker(loc.coordinates)
                ));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
 
        // Display locations on map
        function displayLocationsOnMap(locations) {
            markersGroup.clearLayers();
 
            locations.forEach(location => {
                const hauntedIcon = L.divIcon({
                    className: 'haunted-marker',
                    html: '📍',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
 
                const marker = L.marker(location.coordinates, {
                    icon: hauntedIcon
                }).addTo(markersGroup);
 
                const popupContent = `
                    <div style="max-width: 300px;">
                        <h3 style="margin-bottom: 10px;">${location.name}</h3>
                        ${location.imageUrl ? `
                            <img src="${location.imageUrl}" 
                                 alt="${location.name}" 
                                 style="width: 100%; max-width: 280px; height: 180px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;"
                                 onerror="this.style.display='none'">
                        ` : ''}
                        <p style="margin-bottom: 5px;"><strong>Location:</strong> ${location.city}, ${location.state}</p>
                        <p style="margin-bottom: 5px;"><strong>Type:</strong> ${location.type}</p>
                        <p style="margin-bottom: 5px;"><strong>Established:</strong> ${location.yearEstablished}</p>
                        <p style="margin-bottom: 10px;"><strong>Activity Level:</strong> <span style="color: ${location.activityLevel === 'high' ? '#ff4444' : location.activityLevel === 'moderate' ? '#ffaa44' : '#44ff44'};">${location.activityLevel.toUpperCase()}</span></p>
                        <div style="margin-bottom: 10px;">
                            <strong>Story:</strong>
                            <p style="margin-top: 5px; line-height: 1.4; font-size: 0.9em;">${location.story}</p>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Reported Phenomena:</strong>
                            <div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${location.features.map(feature => `<span style="background: rgba(255, 107, 53, 0.2); color: #ff6b35; padding: 2px 6px; border-radius: 8px; font-size: 0.8em; border: 1px solid rgba(255, 107, 53, 0.3);">${feature}</span>`).join('')}
                            </div>
                        </div>
                        ${location.imageSource ? `<div style="text-align: center;"><span style="background: rgba(255, 107, 53, 0.2); color: #ff6b35; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; border: 1px solid rgba(255, 107, 53, 0.3);">📸 ${location.imageSource}</span></div>` : ''}
                    </div>
                `;
 
                marker.bindPopup(popupContent, {
                    maxWidth: 320,
                    maxHeight: 400,
                    className: 'haunted-popup'
                });

                marker.on('click', () => {
                    marker.openPopup();
                });
            });
        }
 
        // Display locations list
        function displayLocationsList(locations) {
            const listContainer = document.getElementById('locationsList');
            
            listContainer.innerHTML = locations.map(location => `
                <div class="location-card activity-${location.activityLevel}" data-id="${location.id}">
                    ${location.imageUrl ? `
                        <div class="location-image">
                            <img src="${location.imageUrl}" 
                                 alt="${location.name}" 
                                 onerror="this.style.display='none'"
                                 loading="lazy">
                        </div>
                    ` : ''}
                    <div class="location-title">${location.name}</div>
                    <div class="coordinates">${location.city}, ${location.state}</div>
                    <div class="location-type">${location.type}</div>
                    <div class="location-story">${location.story}</div>
                    <div class="location-features">
                        <h4>Reported Phenomena:</h4>
                        <div class="features-list">
                            ${location.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                        </div>
                    </div>
                    ${location.imageSource ? `<div class="image-source-badge">Source: ${location.imageSource}</div>` : ''}
                </div>
            `).join('');
        }
 
        // Update statistics
        function updateStatistics() {
            const totalCount = hauntedLocations.length;
            const highActivityCount = hauntedLocations.filter(loc => loc.activityLevel === 'high').length;
            
            document.getElementById('totalLocations').textContent = totalCount;
            document.getElementById('highActivity').textContent = highActivityCount;
        }
 
        // Update displayed count
        function updateDisplayedCount(count) {
            document.getElementById('displayedCount').textContent = count;
        }
 
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
 
        // Add event listeners for filtering
        document.getElementById('stateFilter').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('locationType').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('activityLevel').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('sortOrder').addEventListener('change', filterAndDisplayLocations);
    </script>
</body>
</html>
